### é¡¹ç›®è¯´æ˜
æœ¬é¡¹ç›®åŸæœ¬æ˜¯è¶…çº§è·‘è·‘çš„å¤åˆ»ç‰ˆæœ¬(æœªå®Œæˆå“), ç”±äºæ‰¾æš‘æœŸå®ä¹ ä¸´è¿‘, æ•…è€Œæ›´æ–°ä¸€ä¸‹è‡ªå·±çš„é¡¹ç›®è¿›å±•.

æœ¬é¡¹ç›®æ„æ€æ˜¯åšä¸€æ¬¾å¤šäººè”æœºç«æŠ€ç«é€Ÿç½‘æ¸¸. æ¬²å‚è€ƒ**UE5 Lyra Sample Game**ç¤ºä¾‹é¡¹ç›®, ç”±äºç›®å‰è¯¥é¡¹ç›®å¹¶æœªå®Œç»“, ç°å±•ç¤ºå¯¹**Lyra çš„æ¡†æ¶çš„å­¦ä¹ ä¸è§£è¯»**ä»¥åŠéƒ¨åˆ†é¡¹ç›®æ„æ€åŠå±•ç°.

é¡¹ç›®é…ç½®:
- UE5.2 (Epic Version)

~~æœ¬é¡¹ç›®æ˜¯è¶…çº§è·‘è·‘(è‹±æ–‡å:`TalesRunner`)çš„`UE`å¤åˆ»ç‰ˆæœ¬(æŠ„è¢­ç‰ˆ).~~

~~2024.3.13æ›´æ–°: è¯´æ¥æŒºæƒ­æ„§çš„, æœ¬æ¥è®¤ä¸ºèƒ½å¤Ÿåœ¨æ‰¾å®ä¹ ä¹‹å‰åšå‡ºæ¥å¤§è‡´çš„æ ·å­çš„, ä½†ç°åœ¨æ„Ÿè§‰ä¸è¡Œäº†. åªèƒ½å°†ç›®å‰æ‰€å®Œæˆçš„éƒ¨åˆ†è®¾è®¡æ„æ€ä»¥åŠæ¶æ„å­¦ä¹ ç¬”è®°æ›´æ–°ä¸€ä¸‹äº†.~~

~~*ç‰ˆæƒå£°æ˜: æœ¬é¡¹ç›®ä»…ä»…æ˜¯`Demo`æ€§è´¨çš„, ä¸åŒ…å«ä»»ä½•ç›ˆåˆ©éƒ¨åˆ†, å­˜åœ¨çš„ç›®çš„ä»…ä»…æ˜¯ç”¨ä½œæ£€éªŒ`UE`çš„å­¦ä¹ æˆæœ.* **å¦‚æœ‰ä¾µçŠ¯åŸæ¸¸æˆçš„ä»»ä½•åˆ©ç›Š, å¯è”ç³»æˆ‘ç«‹å³åˆ é™¤.**~~

ä»¥ä¸‹è§£è¯»æ–‡æ¡£ä¹Ÿå¯å‚è€ƒä¸ªäººåšå®¢: [TalesRunnerè¶…çº§è·‘è·‘UEå¤åˆ»ç‰ˆ(æŠ„è¢­ç‰ˆ)æ„å»ºè¿‡ç¨‹](https://www.d1anhua.top/2024/03/21/TalesRunner%E8%B6%85%E7%BA%A7%E8%B7%91%E8%B7%91UE%E5%A4%8D%E5%88%BB%E7%89%88-%E6%8A%84%E8%A2%AD%E7%89%88-%E6%9E%84%E5%BB%BA%E8%BF%87%E7%A8%8B/)

## LyraExperienceæ¨¡å—è§£è¯».

`Lyra`æ·»åŠ äº†æ–°çš„`Experience`æ¨¡å—, å…¶å®˜æ–¹åŒ…æ‹¬ç½‘ä¸Šçš„ä¸€äº›èµ„æ–™éƒ½ä»‹ç»è¯´å®ƒæ˜¯`GameMode`çš„é«˜çº§ç‰ˆæœ¬. ä»Šå¤©, å°†é¦–å…ˆä»`LyraExperience`è¿™ä¸ªæ¨¡å—æ¥è®²è§£è¿™ä¸ªé¡¹ç›®.

**æ³¨:**ä¸ªäººä¹Ÿæ˜¯UEæ–°æ‰‹, å¦‚æœæ–‡ç« ä¸­æœ‰é”™è¯¯, å¸Œæœ›å¤§å®¶å¯ä»¥æ‰¹è¯„æŒ‡å‡º, æˆ‘ä¼šå°½é‡æ”¹æ­£, é¿å…ç»™å¤§å®¶é€ æˆè¯¯è§£.

(PS: çº¯çœ‹è¿™ä¸ªé¡¹ç›®çš„è¯, ç¡®å®æ„Ÿè§‰å¯ä»¥ä»`LyraExperience`è¿™ä¸ªæ¨¡å—å¼€å§‹çœ‹, ä½†æ˜¯æˆ‘ä¸ªäººæ„Ÿè§‰è¿™ä¸ªé¡¹ç›®åœ¨å„ä¸ªæ¨¡å—ä¹‹é—´çš„è€¦åˆåº¦ã€ä»¥åŠå¯¹`Tag && Assets Data`çš„ä½¿ç”¨è¶…ä¹æˆ‘çš„æƒ³è±¡. è¦æ˜¯æƒ³è¦é‡æ–°å¤åˆ»è¿™ä¸ªé¡¹ç›®çš„è¯, æˆ‘å»ºè®®ä»`Character && Modular Gameplay`çœ‹èµ·)

> å…ˆè¯´ä¸€äº›ç¢ç¢å¿µå§:
> æˆ‘æœ¬èº«å¹¶ä¸æ˜¯`UE`è€æ‰‹, æœ€è¿‘æƒ³åšä¸€ä¸ª`DEMO`é¡¹ç›®å¥½è®©è‡ªå·±åœ¨æ±‚èŒå­£å¤šç‚¹å§¿è‰². å½“æ—¶æƒ³é€šè¿‡å­¦ä¹ `Lyra`é¡¹ç›®æ¥å­¦ä¹ ä¸€äº›`Epic`å®˜æ–¹çš„ä»£ç é£æ ¼, ä»¥åŠå­¦ä¹ ä¸€ä¸‹ä»–ä»¬æ˜¯å¦‚ä½•æ„å»ºé¡¹ç›®çš„.
>
> ç»“æœä¸å‡ºæ‰€æ–™åœ°æ˜¯, æˆ‘å®Œå…¨ä½ä¼°äº†`Lyra`é¡¹ç›®çš„éš¾åº¦, ç»“æœä¸å¯é¿å…çš„è®©è‡ªå·±çš„`Demo`æ²¡æœ‰åŠæ³•æŒ‰æœŸå®Œæˆäº†(ğŸ¤¨), è®©è‡ªå·±å½“åˆçš„æƒ³æ³•æ˜¾å¾—å¤©çœŸäº†ä¸€äº›.
>
> **ä¸è¿‡å¿…é¡»è¦è¯´çš„æ˜¯**: è™½ç„¶è‡ªå·±çš„`Demo`æ˜¯è¦é”™è¿‡æš‘æœŸå®ä¹ çš„æ—¶é—´äº†, ä¸è¿‡ç§‹æ‹›è¿˜æ˜¯å¯ä»¥åŠªåŠªåŠ›çš„. å¦å¤–å°±æ˜¯, `lyra`è¿™ä¸ªé¡¹ç›®è¿˜æ˜¯å¯ä»¥è®©äººå­¦åˆ°å¾ˆå¤šä¸œè¥¿çš„.
>
> å‰©ä¸‹çš„å°±ä¸å¤šå¿µå¨äº†. æå‰æ„Ÿè°¢å¤§å®¶çš„è§‚çœ‹äº†.

æˆ‘çš„å‚è€ƒé“¾æ¥æ”¾åœ¨å¼€å¤´, å› ä¸ºæˆ‘æ„Ÿè§‰æˆ‘è‡ªå·±çš„æ–‡ç« æœ¬èº«å‡ºè‡ªåˆ«äºº, å¹¶ä¸”è‡ªå·±å†™çš„è´¨é‡ä¹Ÿä¸ä¸€å®šæœ‰åˆ«äººé«˜. æ„Ÿå…´è¶£çš„å¯ä»¥ç›´æ¥çœ‹åˆ«äººçš„æ–‡ç« å‘€.\
1. [çŸ¥ä¹---UE5 æ–°é¡¹ç›®Gameplayæ¡†æ¶è®¾è®¡ï¼ˆä»¥Lyraä¸ºä¾‹ï¼‰](https://zhuanlan.zhihu.com/p/614718286)\
2. [çŸ¥ä¹---UE5 Lyraçš„æ•°æ®é©±åŠ¨ä¹‹æ•°æ®åŠ è½½ä¸å¼•ç”¨](https://zhuanlan.zhihu.com/p/505766201)\
3. [çŸ¥ä¹---ã€ŠInsideUE5ã€‹GameFeaturesæ¶æ„ï¼ˆä¸€ï¼‰å‘å±•ç”±æ¥](https://zhuanlan.zhihu.com/p/467236675)\
4. [Youtube---Modular Game Features in UE5: plug â€˜n play, the Unreal way](https://www.youtube.com/watch?v=3PBnqC7TxvM)\
5. [å®˜æ–¹æ–‡æ¡£: Game Featrues and Modular Gameplay](https://docs.unrealengine.com/5.1/en-US/game-features-and-modular-gameplay-in-unreal-engine/)\

### What is Experience
æˆ‘ä¸ªäººçš„ç†è§£çš„è¯, æ•…åæ€æ„, å°±å¯ä»¥ç†è§£ä¸ºæ˜¯ä¸€ç§æ¸¸ç©çš„ä½“éªŒ, ä¸ç”¨çš„`Experience`å¯èƒ½å°±æ˜¯ä¸åŒçš„æ¸¸æˆé£æ ¼, å…¶ä¸­åŒ…å«æœ‰è§’è‰²ç›¸å…³çš„ã€æ§åˆ¶æ˜ å°„ç›¸å…³çš„ã€ä¹Ÿæœ‰å’ŒåŠŸèƒ½(GameFeature)ç›¸å…³çš„. è‡³äºå®ƒå’Œä»¥å‰çš„`Gamemode`çš„åŒºåˆ«ä»¥åŠä¼˜åŠ¿. æˆ‘ä¸ªäººå…¶å®å¯¹`Gamemode`çš„ç†è§£ä¹Ÿå¹¶ä¸æ·±åˆ». æ‰€ä»¥æˆ‘ä¹Ÿå°±ä¸åœ¨è¿™é‡Œå¤§æ”¾å¥è¯äº†. å…·ä½“çš„åŠŸèƒ½ä»¥åŠæ–¹ä¾¿ä¸å¦è¿˜æ˜¯ç”±ä¸ªäººè‡ªå·±åŒºåˆ†çš„(æˆ–è€…æœ‰å¤§ä½¬æ„¿æ„è®²è®²å“ˆå“ˆå“ˆ)

**æ³¨:** åœ¨ä»‹ç»ä¹‹å‰, æ–¹ä¾¿çš„åŒå­¦å¯ä»¥å…ˆçœ‹çœ‹å‚è€ƒé“¾æ¥4æˆ–è€…5ä»¥ç®€å•çš„äº†è§£ä¸€ä¸‹`GameFeatrue`. `GameFeatrue`åœ¨`Lyra`ä¸­ä¹Ÿæ˜¯æ·±åº¦é›†æˆçš„.\

ä¸äº†è§£ä¹Ÿè¡Œ, å°±çŸ¥é“å®ƒæ˜¯ä¸€ç§åœ¨**ä¸å½±å“æ¸¸æˆåŸæœ‰Componentè¿è¡Œè¿‡ç¨‹**ä¹‹å¤–, æ‰€æ·»åŠ çš„ä¸€äº›é¢å¤–çš„åŠŸèƒ½.\
è¿™é‡Œæˆ‘ç®€å•ä¸¾ä¾‹å°±åƒåŠ å…¥æˆ‘ç°åœ¨åªæœ‰ä¸€ä¸ªèƒ½è¡Œèµ°çš„è§’è‰². æˆ‘å¯ä»¥å°†å…¶ä»–ä»»ä½•çš„é€»è¾‘éƒ½é€šè¿‡`GameFeatrue`åœ¨ä¸å½±å“æ¸¸æˆæœ¬èº«ä»¥åŠå„ä¸ªéƒ¨ä»¶ä¹‹é—´è¿è¡Œçš„å‰æä¸‹å»å¢åŠ è¯¸å¦‚UIã€æ–°çš„åŠŸèƒ½ç­‰ç­‰, å¯ä»¥ä¸°å¯Œè¿™ä¸ªæ¸¸æˆ.(å¤§é’Šè€å¸ˆçš„ä¸¾ä¾‹å¾ˆå½¢è±¡. å¾€ä¸»æ¿ä¸Šæ‹“å±•çš„æ€è·¯)

#### LyraExperienceDefinition
`ExperienceDefinition`å®šä¹‰å¦‚ä¸‹:
![](https://hexoblog-1304281944.cos.ap-hongkong.myqcloud.com/hexo/pic/2024-03-13-22-09-01.png)

> åœ¨UE5ä¸­å±•ç¤ºå¦‚ä¸‹:
> ![](https://hexoblog-1304281944.cos.ap-hongkong.myqcloud.com/hexo/pic/2024-03-13-21-54-32.png)
> å…¶è®¾ç½®ä½ç½®åœ¨`World Setting-->GameMode`ä¸‹:
> ![](https://hexoblog-1304281944.cos.ap-hongkong.myqcloud.com/hexo/pic/2024-03-13-22-00-12.png)


> æ³¨: è¿™é‡Œè®¾ç½®çš„ä½ç½®å…¶å®æ˜¯`Lyra`ç»§æ‰¿äº†`AWorldSettings`(å¯ä»¥åœ¨ä»¥åçš„å·¥ä½œä¸­ä¹Ÿå°è¯•å°è¯•):
> ``` cpp
> class LYRAGAME_API ALyraWorldSettings : public AWorldSettings{
>  	UPROPERTY(EditDefaultsOnly, Category=GameMode)
>   TSoftClassPtr<ULyraExperienceDefinition> DefaultGameplayExperience; 
> ... }
> ```

`Experience`æ€»å…±ç”±å››ä¸ªæˆå‘˜å˜é‡ç»„æˆ, å…¶ä¸­é™¤äº†ç¬¬ä¸€ä¸ªä¹‹å¤–å…¨æ˜¯Lyraçš„è‡ªå®šä¹‰ç±»å‹. è¿™é‡Œæˆ‘ç®€å•ä»‹ç»ä¸€ä¸‹, æœ‰ä¸ªæ¦‚å¿µå°±è¡Œ.(è¿™å››éƒ¨åˆ†å°±æ˜¯æ•´ä¸ª`Experience`æ‰€æä¾›çš„æœåŠ¡çš„å…¨éƒ¨äº†, å¯ä»¥è¯´):\
1. GameFeaturesToEnable: å°†è¦ä½¿ç”¨çš„æ˜¯å“ªä¸€ç³»åˆ—çš„`GameFeatures`.
2.


## LyraModularGameplay && ModularGameplayActor && Enhanced Input(Tag)æ¨¡å—è§£è¯»

`Lyra`é¡¹ç›®åœ¨æ•´ä¸ª`Character`çš„æ„å»ºè¿‡ç¨‹ä¸­, éƒ½è¿ç”¨äº†`ModularGameplay`è¿™ä¸ªæ’ä»¶. åˆšå…¥æ‰‹ä¸€ä¸ªé¡¹ç›®çš„ç¬¬ä¸€æ­¥, æˆ‘ä¸ªäººè§‰å¾—è¿˜æ˜¯åº”è¯¥å…ˆçœ‹çœ‹`Lyra`è§’è‰²æ˜¯æ€ä¹ˆè®¾ç½®çš„.

æœ¬æ–‡ç« ä¸»è¦åŒ…å«`Lyra`çš„ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†:\
1. ModularGameplay\
2. Enhanced Input Mapping(åŒ`Tag`ç»‘å®š)\
3. LyraPawnExtensionComp && LyraHeroComp ä¹‹é—´çš„Initialization State System.\
   æœ¬éƒ¨åˆ†ä¸ä¼šæ¶‰åŠ`GAS`ç³»ç»Ÿç›¸å…³çš„éƒ¨åˆ†, `GAS`ä¼šæ”¾åé¢è®².

**æ³¨:**æˆ‘æœ¬äººä¹Ÿæ˜¯UEå­¦ä¹ çš„æ–°æ‰‹, å¯¹åŸºç¡€æ¦‚å¿µæŒæ¡å¹¶ä¸æ·±, å¦‚æœæœ‰åˆ†æé”™è¯¯çš„åœ°æ–¹, è¿˜è¯·å¤§å®¶æ‰¹è¯„æŒ‡æ­£, ä¹Ÿé¿å…è¯¯å¯¼å¤§å®¶.

å‚è€ƒé“¾æ¥å¦‚ä¸‹:\
1. [å®˜æ–¹æ–‡æ¡£: Game Framework Component Manager](https://docs.unrealengine.com/5.1/en-US/game-framework-component-manager-in-unreal-engine/)

### ModularGameplayActor
`Lyra`æ’ä»¶ç›®å½•ä¸­æœ‰ä¸€ä¸ªæ’ä»¶:`ModularGameplayActor`, å…¶ä¸­åŒ…å«äº†å¸¸ç”¨çš„Actorçš„`MudoularGameplay`çš„å®ç°, ä¸ºåœ¨[å‚è€ƒé“¾æ¥1](https://docs.unrealengine.com/5.1/en-US/game-framework-component-manager-in-unreal-engine/)ä¸­çš„ç¬¬ä¸€éƒ¨åˆ†`Extension Handler System`æä¾›äº†é»˜è®¤çš„å®ç°.
![](https://hexoblog-1304281944.cos.ap-hongkong.myqcloud.com/hexo/pic/2024-03-18-16-35-24.png)\

åœ¨æ¯ä¸€ä¸ª`ModularGameplayActor`çš„å®ç°ä¸­, æœ€ä¸»è¦çš„åœ¨`PreInitalizeComponents()`ä¸­æ³¨å†Œæˆä¸ºäº†Reveiver, å¹¶åœ¨`EndPlay()`ä¸­`RemoveReceiver`.\

> ``` cpp
> // ModularCharacter.cpp
> void AModularCharacter::PreInitializeComponents()
> {
> 	Super::PreInitializeComponents();
> 	UGameFrameworkComponentManager::AddGameFrameworkComponentReceiver(this);
> }
> void AModularCharacter::EndPlay(const EEndPlayReason::Type EndPlayReason)
> {
> 	UGameFrameworkComponentManager::RemoveGameFrameworkComponentReceiver(this);
> 	Super::EndPlay(EndPlayReason);
> }
> void AModularCharacter::BeginPlay()
> {
>   //! æ³¨å†Œäº†æ—¶é—´åä¸ºNAME_GameActorReadyçš„Default Event(è¿™ä¸ªäº‹ä»¶å£°æ˜åœ¨GameFrameworkComponentManager.hçš„å¤´æ–‡ä»¶ä¸­), æ–¹ä¾¿å…¶ä»–æ’ä»¶ä½¿ç”¨. æ¯”å¦‚åšåŒæ­¥æ§åˆ¶æ—¶
> 	UGameFrameworkComponentManager::SendGameFrameworkComponentExtensionEvent(this, UGameFrameworkComponentManager::NAME_GameActorReady);
> 	Super::BeginPlay();
> }
> 
> // ModularGameMode.cpp
> AModularGameMode::AModularGameMode(const FObjectInitializer& ObjectInitializer)
> 	: Super(ObjectInitializer)
> {
> 	GameStateClass = AModularGameState::StaticClass();
> 	PlayerControllerClass = AModularPlayerController::StaticClass();
> 	PlayerStateClass = AModularPlayerState::StaticClass();
> 	DefaultPawnClass = AModularPawn::StaticClass();
> }
> ```

ä»¥åå¯ä»¥ç›´æ¥ç»§æ‰¿è¿™ä¸ªæ’ä»¶æ¥å®ç°è‡ªå·±`GameFeaturePlugins`çš„å®ç°.

### Input System
**Lyra**çš„`Input System`å¯ä¸`GAS`ã€`GameplayTag`ä»¥åŠä¸åŒçš„æ§åˆ¶å™¨åè°ƒå·¥ä½œ, å…¶åœ¨`EnhancedInput`çš„åŸºç¡€ä¸Šè¿›è¡Œäº†å°è£….

#### Input System Data Stucture
![](https://hexoblog-1304281944.cos.ap-hongkong.myqcloud.com/hexo/pic/2024-03-18-19-16-36.png)

ä¸‹é¢æ”¾ä¸€å¼ æ­£å¸¸çš„ä½¿ç”¨`Enhanced Input System`çš„ä»£ç æˆªå›¾, ä»ä»£ç ä¸­å¯ä»¥çœ‹å‡ºæ¥, å…³äº`Enhanced Input System`ä¸»è¦æœ‰ä¸¤éƒ¨åˆ†:

- InputMappingContext's Bind\
- InputActor's Bind\

å› æ­¤å‘¢, å¯¹åº”çš„`Lyra`åˆ†åˆ«å®šä¹‰äº†è¿™ä¸¤éƒ¨åˆ†çš„æ•°æ®ç»“æ„.
![](https://hexoblog-1304281944.cos.ap-hongkong.myqcloud.com/hexo/pic/2024-03-18-17-21-02.png)

é¦–å…ˆæ˜¯**InputMappingContext**, `Lyra`ä¸­ç›´æ¥ä½¿ç”¨äº†`UPlayerMappableInputConfig`, å…¶ä¸­ç»´æŠ¤äº†ä¸€ä¸ªå«æœ‰`InputMappingContext`çš„Map.

Lyraç³»ç»Ÿä¸ºè¿™ä¸ª`Config`å°è£…äº†`CommonInputType`(*è¿™ä¸ªæšä¸¾ç±»å‹ç”¨æ¥è¯´æ˜æ‰€ä½¿ç”¨çš„æ§åˆ¶å™¨çš„ç±»å‹*)ä¿¡æ¯. å¹¶é€šè¿‡HeroComponentæ¥è®¾ç½®.
![](https://hexoblog-1304281944.cos.ap-hongkong.myqcloud.com/hexo/pic/2024-03-18-18-12-22.png)

è€Œå¦ä¸€æ–¹é¢**InputActions**åˆ™å¯¹é½å°è£…äº†`GameplayTag`ä¿¡æ¯å½¢æˆäº†`LyraInputAction`. å¹¶æ ¹æ®å…¶æ—¶å€™æ˜¯`Ability`è€Œåˆ†ä¸ºäº†`Native`å’Œ`Ability`ä¹‹åˆ†. å¹¶é€šè¿‡`PawnData`è¿›è¡Œè®¾ç½®.
(**æ³¨:** è¿™é‡Œçš„`PawnData`å¹¶ä¸æ˜¯ç®€å•çš„åœ¨`PawnExtensionComp`ä¸­è¿›è¡Œè®¾ç½®çš„, åœ¨`Lyra`å…¶æ˜¯åœ¨`Experience`çš„åˆå§‹åŒ–è¿‡ç¨‹ä¸­ç”±`GameState`å®Œæˆçš„)
![](https://hexoblog-1304281944.cos.ap-hongkong.myqcloud.com/hexo/pic/2024-03-18-18-16-10.png)


